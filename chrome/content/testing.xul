<?xml version="1.0"?>

<?xml-stylesheet href="chrome://global/skin/" type="text/css"?>

<window
    title="Minimeter testground" 
    style="padding: 0px 0px 10px 0px; " 
    xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
    <description value="Enter your provider credentials"/>
     
  <script src="chrome://minimeter/content/Utils.js"/>
  <script src="chrome://minimeter/content/Monitor.js"/>
  <script src="chrome://minimeter/content/Credentials.js"/>
	<script src="chrome://minimeter/content/monitor/Skynet.js"/>
	
	<script>
		var classN = "Tester";
		var scr = "";
		function test(){
			document.getElementById('r').value = '';
			cl = document.getElementById("m").value;
			try{
			eval(cl);
			}catch(e){log("Error in this script: \n" +  e );}
			try{

    	var credentials = new Credentials("chrome://minimeter/");
			var user = credentials.load();	
    
		
			eval("m = new "+classN+"(user.username, user.password)");
			m.useCache = false;
			m.addListener(  { update: 
			function(x){
			if(x.state == 2) return;
				if(x.errorMessage== "" || x.errorMessage==null) x.errorMessage= "No error";
				log("Result State ("+state2string(x.state)+"): \nUsed (in GB): "+x.usedVolume + "\nTotal (in GB): " + x.totalVolume + "\nExtra: " + x.extraMessage + "\nError: " + x.errorMessage);
				 x.removeAllListeners();
			} }  );
			//alert("Tester.check(); ...");
			m.check();
			}catch(e){log("Error while initializing: \n" + e);}
	
		}
		
		function state2string(id){
			switch(id){
				case 2: return "Monitor.prototype.STATE_BUSY";
				case 1: return "Monitor.prototype.STATE_ERROR";
				case 0: return "Monitor.prototype.STATE_DONE";
				case 3: return "Monitor.prototype.STATE_ABORT";
				default: return "???";
			}
			
			
		}
		
		function loadScript(){
		if(scr == "" || scr == null) {alert("set url first");return;}
		try{
  		var req = new XMLHttpRequest();

			req.onreadystatechange = function(){
				if (req.readyState == 4){
					document.getElementById("m").value = req.responseText;
				}
			}

  		
      req.open("GET", scr, true, null, null);
	  	req.send('');	
			
		}catch(ex){alert("Could not load that script: \n" +ex);}		
		}
		
		function setScript(){
			scr = prompt("Enter the url of the online test script (ex. http://epigoon.com/mozilla/minimeter/xxx.js)");
		}
		
		function log(val){
			document.getElementById("r").value += "\n" + val;
		}
	</script>
	
	<vbox flex="3">
		<hbox>debug
	 	<button onclick="test();" label="check" />

		<button onclick="loadScript();" label="reload script" />
		<button onclick="setScript();" label="set online script" />
		<splitter disabled="true"/>
		<button onclick="document.getElementById('r').value = '';" label="clear output" />
		<button onclick="debug(document.getElementById('r').value);" label="output -> clipboard" />
		</hbox>
		<textbox id="m" style="height: 600px;" multiline="true"/>

	</vbox>
	<splitter/>
	<vbox flex="1">
	<textbox id="r" style="height: 200px;" multiline="true" readonly="true"/>
	</vbox>
</window>
